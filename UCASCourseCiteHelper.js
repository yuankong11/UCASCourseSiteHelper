// ==UserScript==
// @name         UCASCourseCiteHelper
// @namespace    Yuankong11
// @version      0.20
// @description  聚合UCAS课程网站的资源和作业页面；资源页面自动按最近修改时间降序排列；自动切换到第二身份。
// @author       Yuankong11
// @require      https://cdn.bootcdn.net/ajax/libs/vue/2.6.12/vue.min.js
// @require      https://unpkg.com/element-ui@2.14.1/lib/index.js
// @require      https://cdn.bootcdn.net/ajax/libs/axios/0.21.0/axios.min.js
// @include      *://course.ucas.ac.cn/portal?sakai.session=*
// @include      *://course.ucas.ac.cn/portal?anotherUser=*
// @include      *://course.ucas.ac.cn/portal/site/*/tool/*
// ==/UserScript==

!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=1)}([function(e,t){e.exports=Vue},function(e,t,r){"use strict";r.r(t);var n=r(0),o=r.n(n),l=function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"vue_app",attrs:{align:"center"}},[t("el-col",{attrs:{span:16,offset:4}},[t("el-card",[t("div",{attrs:{slot:"header"},slot:"header"},[t("span",{staticStyle:{"font-size":"20px"}},[this._v("UCAS课程网站助手")])]),this._v(" "),t("div",[t("Table")],1)])],1)],1)};l._withStripped=!0;var a=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("el-table",{staticStyle:{width:"100%","margin-bottom":"20px","font-size":"16px"},attrs:{data:e.tableData,"row-key":"name",border:"",stripe:"","default-expand-all":"","tree-props":{children:"children"}}},[r("el-table-column",{attrs:{prop:"name",label:"课程"},scopedSlots:e._u([{key:"default",fn:function(t){return[r("a",{attrs:{href:t.row.href}},[e._v(" "+e._s(t.row.name))])]}}])}),e._v(" "),r("el-table-column",{attrs:{prop:"resource",label:"资源",width:"180"},scopedSlots:e._u([{key:"default",fn:function(t){return[null!=t.row.resource?r("a",{attrs:{href:t.row.resource}},[e._v("资源")]):e._e()]}}])}),e._v(" "),r("el-table-column",{attrs:{prop:"homework",label:"作业",width:"180"},scopedSlots:e._u([{key:"default",fn:function(t){return[null!=t.row.homework?r("a",{attrs:{href:t.row.homework}},[e._v("作业")]):e._e()]}}])})],1)};function i(e,t,r,n,o,l,a,i){var s,u="function"==typeof e?e.options:e;if(t&&(u.render=t,u.staticRenderFns=r,u._compiled=!0),n&&(u.functional=!0),l&&(u._scopeId="data-v-"+l),a?(s=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),o&&o.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(a)},u._ssrRegister=s):o&&(s=i?function(){o.call(this,(u.functional?this.parent:this).$root.$options.shadowRoot)}:o),s)if(u.functional){u._injectStyles=s;var c=u.render;u.render=function(e,t){return s.call(t),c(e,t)}}else{var d=u.beforeCreate;u.beforeCreate=d?[].concat(d,s):[s]}return{exports:e,options:u}}a._withStripped=!0;var s=i({name:"Table",data:()=>({tableData:[]}),mounted:function(){this.buildTable()},methods:{testTable(){this.tableData=[{name:"t1",children:[{name:"n1",href:"#",resource:"r1",homework:"h1"}]}]},buildTable(){let e=document.querySelectorAll(".fav-sites-term");this.tableData=[];for(let t=0;t<e.length-1;t++){let r=e[t];this.tableData.push({name:r.querySelector(".favorites-term-header").innerHTML,children:[]});let n=r.querySelectorAll(".fav-sites-entry  ");for(let e=0;e<n.length;e++){let r=n[e].querySelectorAll("a"),o=r[1],l=o.getAttribute("href"),a=o.getAttribute("title");this.tableData[t].children.push({name:a,href:l,resource:"",homework:""});let i=r[2].getAttribute("id"),s="/direct/site/"+i+"/pages.json";axios.get(s).then(r=>{let n=r.data,o=this.tableData[t].children[e];o.resource="https://course.ucas.ac.cn/portal/site/"+i+"/page/"+n[3].id,o.homework="https://course.ucas.ac.cn/portal/site/"+i+"/page/"+n[5].id})}}}}},a,[],!1,null,null,null);s.options.__file="src/Table.vue";var u=i({name:"app",components:{Table:s.exports}},l,[],!1,null,null,null);u.options.__file="src/app.vue";var c=u.exports;if(-1!=document.baseURI.indexOf("site")){let e=document.querySelector('a[title="按最近修改日期排序"]');if(null!=e){null==document.querySelector('img[title="按最近修改日期降序排列"]')&&e.click()}}else if(-1==document.baseURI.indexOf("anotherUser")){let e=document.querySelector('a[href^="/portal?anotherUser="]');null!=e&&e.click()}else{(e=>{const t=document.getElementsByTagName("head")[0],r=document.createElement("link");r.rel="stylesheet",r.type="text/css",r.href=e,r.media="all",t.appendChild(r)})("https://unpkg.com/element-ui@2.14.1/lib/theme-chalk/index.css"),document.body.innerHTML='<div hidden="true">'+document.body.innerHTML+"</div>";let e=document.createElement("div");e.id="vue_app",document.body.appendChild(e),document.head.innerHTML+='<base target="_blank">',new o.a({el:"#vue_app",render:e=>e(c)})}}]);